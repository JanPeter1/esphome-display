api:
  on_client_connected:
    - logger.log: "connected WIFI"
    - delay: 15s
    - script.execute: update_bg_image

online_image:
  - id: bg_image
    url: "http://homeassistant.local:8123/local/bg_images/black.png"
    format: PNG
    type: RGB565
    resize: 800x480
    on_download_finished:
      - logger.log: "bg_image downloaded!"
      - lvgl.update:
          disp_bg_image: bg_image
#      - online_image.release: bg_image
    on_error: 
      - logger.log: "bg_image download failed!"
      - online_image.release: bg_image
#      - delay: 5s
#        ...free memory...
#      - component.update: bg_image

interval:
  - interval: 30min
    then:
      - script.execute: update_bg_image

script:
  - id: update_bg_image
    then:
      - online_image.set_url:
          id: bg_image
          url: !lambda |-
            std::string base = "http://homeassistant.local:8123/local/bg_images/"; 
            std::srand(std::time(0));
            auto filename = base + "bg_image_" + std::to_string(rand() % 87 + 1) + ".png";
            ESP_LOGD("main", filename.c_str());
            return filename;

